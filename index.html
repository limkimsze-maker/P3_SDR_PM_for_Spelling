<!doctype html>
<html lang="en">
<head>
  <!-- PM (Spelling only) â€” Auto Mark | Designed by Lim Kim Sze Â© 2026 -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Cycle 2 PM â€” I Can Spell (Auto Mark)</title>

  <!-- Favicon (Kim Sze standard) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <!-- âœ… Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = (window.ACTIVITY_ID || (location.origin + location.pathname));
    try{
      const del = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) del.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) del.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      sessionStorage.removeItem("UFCO-firstSubmit::"+ACTIVITY_ID);
      sessionStorage.removeItem("sls_scope::"+ACTIVITY_ID);
      try{
        const bc = new BroadcastChannel("xapi-state");
        bc.postMessage({type:"clear", activityId: ACTIVITY_ID, ts: Date.now()});
        bc.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <!-- Counter.dev (Kim Sze standard) -->
  <script async src="https://cdn.counter.dev/script.js"
          data-id="REPLACE_WITH_YOUR_COUNTERDEV_ID"
          data-utcoffset="8"></script>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#334155;
      --paper:#ffffff;

      --line:#0b0f17;
      --grey:#cfcfcf;

      --ok:#16a34a;
      --bad:#dc2626;

      --shadow: 0 18px 52px rgba(2, 6, 23, .12);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      background:#f3f4f6;
      color:var(--ink);
      overflow:auto;           /* mobile can scroll */
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:14px;
      box-sizing:border-box;
    }

    .card{
      width:min(980px, calc(100vw - 20px));
      background:var(--paper);
      border:5px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px 10px;
      border-bottom:5px solid var(--line);
      flex-wrap:wrap;
    }
    .hdrLeft{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .hdr h1{
      margin:0;
      font-size:32px;
      font-weight:1000;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .pencil{
      width:44px; height:44px;
      border-radius:10px;
      background:#e5e7eb;
      display:grid;
      place-items:center;
      font-weight:1000;
      color:#111827;
      user-select:none;
    }

    .nameBox{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      font-size:16px;
    }
    .nameInput{
      width:min(320px, 70vw);
      border:3px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      font-size:16px;
      outline:none;
    }

    .sub{
      padding:10px 16px 12px 16px;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      line-height:1.35;
    }

    /* Try headers row */
    .tryHead{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      border-top:5px solid var(--line);
      border-bottom:5px solid var(--line);
      background:var(--grey);
    }
    .tryHead div{
      padding:10px 12px;
      font-weight:1000;
      font-size:22px;
      border-left:5px solid var(--line);
    }
    .tryHead div:first-child{border-left:0;}

    /* Date row (like booklet: Date:) */
    .dateRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      border-bottom:5px solid var(--line);
      background:#fff;
    }
    .dateCell{
      padding:10px 12px;
      border-left:5px solid var(--line);
      font-weight:1000;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dateCell:first-child{border-left:0;}
    .dateLabel{white-space:nowrap;}
    .dateVal{
      flex:1;
      border-bottom:3px solid var(--line);
      padding:4px 6px;
      min-height:24px;
      font-weight:1000;
      color:#0b1220;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .lockedTag{
      display:inline-block;
      margin-left:8px;
      font-size:12px;
      font-weight:1000;
      padding:4px 8px;
      border-radius:999px;
      border:2px solid #64748b;
      color:#64748b;
      background:#f8fafc;
      white-space:nowrap;
    }

    /* Main 3-column area */
    .tries{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      min-height: 340px;
    }
    .tryCol{
      border-left:5px solid var(--line);
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .tryCol:first-child{border-left:0;}

    .blankArea{
      flex:1 1 auto;
      padding:18px 18px 10px;
      display:flex;
      flex-direction:column;
      gap:22px;
      min-height: 260px;
    }

    .line{
      display:grid;
      grid-template-columns: 40px 1fr 46px;
      gap:10px;
      align-items:end;
      min-width:0;
    }
    .idx{
      font-size:22px;
      font-weight:1000;
      text-align:right;
      padding-bottom:6px;
      user-select:none;
    }

    .ansWrap{min-width:0; position:relative;}
    .ans{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:22px;
      font-weight:900;
      letter-spacing:1px;
      text-transform:lowercase;
      padding:2px 6px 10px 6px;
      border-bottom:4px solid var(--line);
      box-sizing:border-box;
    }
    .ans:disabled{opacity:.55;}

    .hear{
      width:46px; height:46px;
      border-radius:14px;
      border:3px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:18px;
      display:grid;
      place-items:center;
      font-weight:1000;
      user-select:none;
      flex:0 0 auto;
    }
    .hear:active{transform:translateY(1px);}

    /* Marking result under each line */
    .mk{
      margin-top:8px;
      min-height:28px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-weight:1000;
      font-size:18px;
    }
    .tick{color:var(--ok);}
    .cross{color:var(--bad);}

    .circWord{
      display:inline-flex;
      gap:2px;
      font-size:22px;
      letter-spacing:1px;
      text-transform:lowercase;
      align-items:center;
      flex-wrap:wrap;
    }
    .ch{
      display:inline-block;
      padding:0 3px;
      min-width:0.9em;
      text-align:center;
      line-height:1.1;
    }
    .wrong{
      border:3px solid #ef4444;
      border-radius:999px;
    }
    .miss{color:#ef4444;}

    /* Bottom star bar like the booklet */
    .starBar{
      background:var(--grey);
      border-top:5px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
      padding:14px 16px;
      gap:10px;
    }
    .starBox{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      font-weight:1000;
      font-size:26px;
      opacity:.65;
      border-radius:14px;
      padding:10px 12px;
      user-select:none;
    }
    .star{
      font-size:44px;
      line-height:1;
    }
    .starActive{
      opacity:1;
      background:#fff;
      border:4px solid var(--line);
    }

    /* Sticky action bar (MARK / unlock / json) */
    .actionBar{
      position:sticky;
      bottom:0;
      background:#ffffff;
      border-top:5px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      z-index:10;
      flex-wrap:wrap;
    }

    .leftCtl{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      box-shadow:0 10px 26px rgba(2,6,23,.12);
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px);}
    .btn.primary{background:#0ea5e9; color:#fff;}
    .btn.secondary{background:#64748b; color:#fff;}
    .btn.good{background:var(--ok); color:#fff;}
    .btn.danger{background:#dc2626; color:#fff;}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}

    .pill{
      border:3px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      font-weight:1000;
      background:#fff;
      white-space:nowrap;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:14px;
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      font-weight:1000;
      white-space:nowrap;
    }
    .toggle input{width:18px; height:18px;}

    select{
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      font-weight:900;
      max-width:260px;
    }

    .fileBtn{
      position:relative;
      overflow:hidden;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .fileBtn input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .credit{
      padding:10px 14px;
      text-align:right;
      color:#64748b;
      font-weight:900;
      font-size:12px;
      border-top:1px solid #e5e7eb;
    }

    @media (max-width: 520px){
      .hdr h1{font-size:26px;}
      .tryHead div{font-size:18px;}
      .idx{font-size:18px;}
      .ans{font-size:18px;}
      .starBox{font-size:18px;}
      .star{font-size:34px;}
      .dateCell{font-size:14px;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card" id="card">
    <div class="hdr">
      <div class="hdrLeft">
        <h1>I Can Spell</h1>
        <div class="pencil" aria-hidden="true">âœŽ</div>
      </div>

      <div class="nameBox">
        <span>Name:</span>
        <input class="nameInput" id="studentName" placeholder="Teacher to key in pupil name" />
      </div>
    </div>

    <div class="sub">
      Spelling (Auto Mark). Marking focuses on mastery of the <b>target rule only</b>.
      Correct if the target phonogram is present at the <b>end</b> (ff / ll / ss / zz).
      Mastery is <b>about 80%</b>.
    </div>

    <div class="tryHead">
      <div>1st try</div>
      <div>2nd try</div>
      <div>3rd try</div>
    </div>

    <div class="dateRow">
      <div class="dateCell">
        <span class="dateLabel">Date:</span>
        <span class="dateVal" id="date-1"></span>
      </div>
      <div class="dateCell">
        <span class="dateLabel">Date:</span>
        <span class="dateVal" id="date-2"></span>
        <span class="lockedTag" id="lockTag-2">LOCKED</span>
      </div>
      <div class="dateCell">
        <span class="dateLabel">Date:</span>
        <span class="dateVal" id="date-3"></span>
        <span class="lockedTag" id="lockTag-3">LOCKED</span>
      </div>
    </div>

    <div class="tries" id="tries">
      <div class="tryCol" data-try="1">
        <div class="blankArea" id="area-1"></div>
      </div>
      <div class="tryCol" data-try="2">
        <div class="blankArea" id="area-2"></div>
      </div>
      <div class="tryCol" data-try="3">
        <div class="blankArea" id="area-3"></div>
      </div>
    </div>

    <div class="starBar">
      <div class="starBox starActive" id="workBox">
        <div class="star">â˜†</div>
        <div>Weâ€™re working on it!</div>
      </div>
      <div class="starBox" id="mastBox">
        <div class="star">â˜†</div>
        <div>Iâ€™ve mastered it! â˜º</div>
      </div>
    </div>

    <div class="actionBar">
      <div class="leftCtl">
        <button class="btn secondary" id="unlockAudioBtn" type="button">Unlock Audio</button>

        <div class="toggle">
          <input id="soundOn" type="checkbox" checked>
          <label for="soundOn">Speech On</label>
        </div>

        <select id="voiceSel" aria-label="Voice selection"></select>

        <span class="pill" id="tryPill">Current: 1st try</span>
        <span class="pill" id="scorePill">Score: â€”</span>
      </div>

      <div class="leftCtl">
        <button class="btn secondary" id="unlock2Btn" type="button">Unlock 2nd Try</button>
        <button class="btn secondary" id="unlock3Btn" type="button">Unlock 3rd Try</button>

        <button class="btn primary" id="markBtn" type="button">MARK</button>

        <button class="btn good" id="exportBtn" type="button">Download JSON</button>

        <label class="btn good fileBtn" type="button">
          Upload JSON
          <input id="importFile" type="file" accept="application/json">
        </label>

        <button class="btn danger" id="resetBtn" type="button">New Pupil â€” Clear</button>
      </div>
    </div>

    <div class="credit">Designed by Lim Kim Sze Â© 2026</div>
  </div>
</div>

<script>
/* ======================
   Words (from your Teacher's Scoring Booklet image)
   1st try: Fill, Dress
   2nd try: Stuff, Miss
   3rd try: Less, Jazz
   ====================== */
const TRIES = {
  1: [
    { word:"fill",  sentence:"Fill. Fill up your water bottle before PE lesson. Fill." },
    { word:"dress", sentence:"Dress. She bought a new dress to wear for her birthday party. Dress." }
  ],
  2: [
    { word:"stuff", sentence:"Stuff. Eat slowly and do not stuff the food into your mouth. Stuff." },
    { word:"miss",  sentence:"Miss. I will miss my friend when he goes to another school. Miss." }
  ],
  3: [
    { word:"less",  sentence:"Less. He ate less rice today as he was not hungry. Less." },
    { word:"jazz",  sentence:"Jazz. He listens to jazz music to relax. Jazz." }
  ]
};

const PASSWORD = "0000";
const TARGETS = ["ff","ll","ss","zz"];

/* ======================
   DOM
   ====================== */
const studentName = document.getElementById("studentName");

const soundOn  = document.getElementById("soundOn");
const voiceSel = document.getElementById("voiceSel");

const unlockAudioBtn = document.getElementById("unlockAudioBtn");
const unlock2Btn = document.getElementById("unlock2Btn");
const unlock3Btn = document.getElementById("unlock3Btn");

const markBtn  = document.getElementById("markBtn");
const resetBtn = document.getElementById("resetBtn");

const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");

const workBox  = document.getElementById("workBox");
const mastBox  = document.getElementById("mastBox");

const tryPill   = document.getElementById("tryPill");
const scorePill = document.getElementById("scorePill");

const date1El = document.getElementById("date-1");
const date2El = document.getElementById("date-2");
const date3El = document.getElementById("date-3");
const lockTag2 = document.getElementById("lockTag-2");
const lockTag3 = document.getElementById("lockTag-3");

/* ======================
   State
   ====================== */
let unlocked = false;
let currentTry = 1;

let tryUnlocked = {1:true, 2:false, 3:false};     // teacher unlocks 2/3
let marked = {1:false, 2:false, 3:false};         // whether marked
let tryDate = {1:"", 2:"", 3:""};                 // YYYY-MM-DD
let tryScore = {1:null, 2:null, 3:null};          // {correct,total,need,mastered}

function todayYMD(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setDateIfEmpty(t){
  if(!tryDate[t]){
    tryDate[t] = todayYMD();
    renderDates();
  }
}
function renderDates(){
  date1El.textContent = tryDate[1] || "";
  date2El.textContent = tryDate[2] || "";
  date3El.textContent = tryDate[3] || "";

  lockTag2.style.display = tryUnlocked[2] ? "none" : "inline-block";
  lockTag3.style.display = tryUnlocked[3] ? "none" : "inline-block";
}

/* ======================
   Helpers
   ====================== */
function ensureUnlocked(){
  if(unlocked) return;
  unlocked = true;
  unlockAudioBtn.textContent = "Audio Unlocked";
  unlockAudioBtn.disabled = true;
  if("speechSynthesis" in window) setTimeout(loadVoices, 0);
}

function cleanAnswer(s){
  return (s||"").toLowerCase().replace(/[^a-z]/g,"");
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  })[m]);
}
function targetForWord(expected){
  const w = cleanAnswer(expected);
  for(const t of TARGETS){
    if(w.endsWith(t)) return t;
  }
  return w.slice(-2);
}
function masteryNeed(n){
  return Math.max(1, Math.round(0.8*n)); // about 80%
}
function setStar(mastered){
  if(mastered){
    workBox.classList.remove("starActive");
    mastBox.classList.add("starActive");
  }else{
    mastBox.classList.remove("starActive");
    workBox.classList.add("starActive");
  }
}
function setCurrentTry(t){
  currentTry = t;
  const name = (t===1 ? "1st try" : t===2 ? "2nd try" : "3rd try");
  tryPill.textContent = `Current: ${name}`;
}

/* ======================
   Build booklet-like lines (NO per-line instruction text)
   ====================== */
function lineHtml(tryNo, idx){
  const id = `t${tryNo}-${idx}`;
  const disabled = !tryUnlocked[tryNo];
  return `
    <div>
      <div class="line" id="row-${id}">
        <div class="idx">${idx+1})</div>
        <div class="ansWrap">
          <input class="ans" id="in-${id}" ${disabled ? "disabled" : ""} autocomplete="off" spellcheck="false" inputmode="text">
        </div>
        <button class="hear" type="button" data-try="${tryNo}" data-idx="${idx}" ${disabled ? "disabled" : ""}>ðŸ”Š</button>
      </div>
      <div class="mk" id="mk-${id}"></div>
    </div>
  `;
}

function rebuildAll(){
  for(const t of [1,2,3]){
    document.getElementById(`area-${t}`).innerHTML =
      TRIES[t].map((_,i)=>lineHtml(t,i)).join("");
  }
  // restore inputs if we already have answers loaded (after JSON import)
  for(const t of [1,2,3]){
    for(let i=0;i<TRIES[t].length;i++){
      const el = document.getElementById(`in-t${t}-${i}`);
      if(el){
        el.value = (stateAnswers[t]?.[i] ?? "");
        el.disabled = !tryUnlocked[t];
      }
      const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
      if(spk) spk.disabled = !tryUnlocked[t];
      const mk = document.getElementById(`mk-t${t}-${i}`);
      if(mk) mk.innerHTML = (stateMarks[t]?.[i] ?? "");
    }
  }
}

/* ======================
   Store answers & mark html for export/import
   ====================== */
let stateAnswers = {1:["",""], 2:["",""], 3:["",""]};
let stateMarks   = {1:["",""], 2:["",""], 3:["",""]};

function captureAnswers(){
  for(const t of [1,2,3]){
    const arr = [];
    for(let i=0;i<TRIES[t].length;i++){
      const el = document.getElementById(`in-t${t}-${i}`);
      arr.push(el ? el.value : "");
    }
    stateAnswers[t] = arr;
  }
}
function captureMarks(){
  for(const t of [1,2,3]){
    const arr = [];
    for(let i=0;i<TRIES[t].length;i++){
      const mk = document.getElementById(`mk-t${t}-${i}`);
      arr.push(mk ? mk.innerHTML : "");
    }
    stateMarks[t] = arr;
  }
}

rebuildAll();

/* lowercase typing */
document.addEventListener("input", (e)=>{
  const el = e.target;
  if(el && el.classList && el.classList.contains("ans")){
    const pos = el.selectionStart;
    el.value = el.value.toLowerCase();
    try{ el.setSelectionRange(pos,pos); }catch(_){}
    // track current try and date
    const m = (el.id||"").match(/^in-t(\d+)-(\d+)$/);
    if(m){
      const t = +m[1];
      setCurrentTry(t);
      setDateIfEmpty(t);
    }
  }
});

/* ======================
   TTS
   ====================== */
function speak(text){
  if(!soundOn.checked) return;
  if(!("speechSynthesis" in window)) return;
  if(!unlocked) return;

  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);

  const vName = voiceSel.value;
  const voices = window.speechSynthesis.getVoices() || [];
  const v = voices.find(x=>x.name===vName);
  if(v) u.voice = v;

  u.rate = 0.95;
  u.pitch = 1.0;
  u.volume = 1.0;

  window.speechSynthesis.speak(u);
}

function loadVoices(){
  if(!("speechSynthesis" in window)) return;
  const voices = window.speechSynthesis.getVoices() || [];
  if(!voices.length) return;

  const prev = voiceSel.value;
  voiceSel.innerHTML = "";

  const sorted = [...voices].sort((a,b)=>{
    const ae = (a.lang||"").toLowerCase().startsWith("en") ? 0 : 1;
    const be = (b.lang||"").toLowerCase().startsWith("en") ? 0 : 1;
    if(ae!==be) return ae-be;
    return (a.name||"").localeCompare(b.name||"");
  });

  for(const v of sorted){
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang||"?"})`;
    voiceSel.appendChild(opt);
  }

  if(prev && [...voiceSel.options].some(o=>o.value===prev)) voiceSel.value = prev;
  else voiceSel.selectedIndex = 0;
}
if("speechSynthesis" in window){
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}

unlockAudioBtn.addEventListener("click", ()=>{
  ensureUnlocked();
  speak("Audio unlocked.");
});

/* Speak prompt when tap ðŸ”Š */
function speakPrompt(tryNo, idx){
  if(!tryUnlocked[tryNo]) return;
  const item = TRIES[tryNo][idx];
  ensureUnlocked();
  setCurrentTry(tryNo);
  setDateIfEmpty(tryNo);
  speak(`Spell this word. ${item.word}. ${item.sentence} The word again. ${item.word}.`);
}

document.addEventListener("click", (e)=>{
  const spk = e.target.closest(".hear");
  if(!spk) return;
  const t = +spk.dataset.try;
  const i = +spk.dataset.idx;
  const input = document.getElementById(`in-t${t}-${i}`);
  if(input && !input.disabled) input.focus();
  speakPrompt(t,i);
});

/* ======================
   Password unlock for try 2 / 3
   ====================== */
function askPassword(){
  const pw = prompt("Teacher password to unlock (0000):");
  return (pw === PASSWORD);
}

function unlockTry(t){
  if(tryUnlocked[t]) return true;
  if(!askPassword()){
    alert("Wrong password.");
    return false;
  }
  tryUnlocked[t] = true;
  setDateIfEmpty(t);
  renderDates();

  // enable inputs + speakers
  for(let i=0;i<TRIES[t].length;i++){
    const el = document.getElementById(`in-t${t}-${i}`);
    if(el) el.disabled = false;
    const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
    if(spk) spk.disabled = false;
  }
  setCurrentTry(t);
  return true;
}

unlock2Btn.addEventListener("click", ()=>unlockTry(2));
unlock3Btn.addEventListener("click", ()=>unlockTry(3));

/* ======================
   Marking: circle wrong letters (vs target word),
   but correctness = target phonogram at end (rule only).
   ====================== */
function circledDiffHtml(answerRaw, expectedRaw){
  const ans = cleanAnswer(answerRaw);
  const exp = cleanAnswer(expectedRaw);

  if(!ans) return `<span class="miss">[ no response ]</span>`;

  const max = Math.max(ans.length, exp.length);
  let out = `<span class="circWord">`;
  for(let i=0;i<max;i++){
    const a = ans[i];
    const e = exp[i];
    if(a === undefined){
      out += `<span class="ch wrong">âˆ…</span>`;
    }else if(e === undefined){
      out += `<span class="ch wrong">${escapeHtml(a)}</span>`;
    }else{
      const wrong = (a !== e);
      out += `<span class="ch ${wrong ? "wrong" : ""}">${escapeHtml(a)}</span>`;
    }
  }
  out += `</span>`;
  return out;
}

function markTry(t){
  if(!tryUnlocked[t]){
    alert("This try is locked. Teacher must unlock first.");
    return;
  }
  setDateIfEmpty(t);

  captureAnswers();

  const total = TRIES[t].length;
  const need = masteryNeed(total);
  let correct = 0;

  for(let i=0;i<total;i++){
    const expected = TRIES[t][i].word;
    const target = targetForWord(expected);

    const input = document.getElementById(`in-t${t}-${i}`);
    const mk = document.getElementById(`mk-t${t}-${i}`);

    const raw = input ? input.value : "";
    const ans = cleanAnswer(raw);

    const ok = ans.endsWith(target) && ans.length >= target.length;
    if(ok) correct++;

    const html = `
      ${circledDiffHtml(raw, expected)}
      <span class="${ok ? "tick":"cross"}">${ok ? "âœ“" : "âœ—"}</span>
      <span style="font-size:13px; color:#475569;">(target: -${target} at the end)</span>
    `;
    if(mk) mk.innerHTML = html;
    stateMarks[t][i] = html;

    if(input) input.disabled = true; // lock after marking
    const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
    if(spk) spk.disabled = true;
  }

  const mastered = (correct >= need);
  marked[t] = true;
  tryScore[t] = {correct, total, need, mastered};

  scorePill.textContent = `Score: ${correct}/${total} (Need ${need})`;
  setStar(mastered);

  if(unlocked && soundOn.checked){
    speak(mastered
      ? `Well done. You have mastered it. You got ${correct} out of ${total}.`
      : `Keep going. You got ${correct} out of ${total}.`);
  }
}

markBtn.addEventListener("click", ()=>{
  ensureUnlocked(); // mobile gesture unlock
  markTry(currentTry);
});

/* Clicking/focusing inside a try makes it current */
document.addEventListener("focusin", (e)=>{
  const el = e.target;
  if(!el || !el.classList || !el.classList.contains("ans")) return;
  const m = (el.id||"").match(/^in-t(\d+)-(\d+)$/);
  if(!m) return;
  const t = +m[1];
  setCurrentTry(t);
  setDateIfEmpty(t);
});

/* ======================
   JSON Export / Import
   ====================== */
function buildExportJson(){
  captureAnswers();
  captureMarks();

  const triesOut = {};
  for(const t of [1,2,3]){
    triesOut[t] = {
      unlocked: !!tryUnlocked[t],
      date: tryDate[t] || "",
      words: TRIES[t].map(x=>x.word),
      sentences: TRIES[t].map(x=>x.sentence),
      responses: stateAnswers[t].slice(),
      marked: !!marked[t],
      score: tryScore[t] ? {...tryScore[t]} : null,
      markHtml: stateMarks[t].slice()
    };
  }

  return {
    version: "pm-spelling-auto-mark-v1",
    exportedAt: new Date().toISOString(),
    studentName: (studentName.value || "").trim(),
    targets: TARGETS.slice(),
    tries: triesOut
  };
}

function downloadJson(obj){
  const fnameBase = (obj.studentName ? obj.studentName.replace(/[^\w\-]+/g,"_") : "PM_Spelling");
  const fname = `${fnameBase}_Cycle2_PM_${todayYMD()}.json`;

  const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fname;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 250);
}

exportBtn.addEventListener("click", ()=>{
  const obj = buildExportJson();
  downloadJson(obj);
});

importFile.addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;

  try{
    const text = await file.text();
    const data = JSON.parse(text);

    if(!data || !data.version || !String(data.version).startsWith("pm-spelling-auto-mark")){
      alert("This JSON file is not a valid PM Spelling record.");
      importFile.value = "";
      return;
    }

    // Load name
    studentName.value = (data.studentName || "");

    // Load tries
    for(const t of [1,2,3]){
      const td = data.tries && data.tries[t];
      if(!td) continue;

      tryUnlocked[t] = !!td.unlocked;
      tryDate[t] = td.date || "";

      stateAnswers[t] = Array.isArray(td.responses) ? td.responses.slice(0, TRIES[t].length) : ["",""];
      stateMarks[t] = Array.isArray(td.markHtml) ? td.markHtml.slice(0, TRIES[t].length) : ["",""];
      marked[t] = !!td.marked;
      tryScore[t] = td.score ? {...td.score} : null;
    }

    // Enforce try 1 unlocked always
    tryUnlocked[1] = true;

    renderDates();
    rebuildAll();

    // Apply lock tags and disable/enable current try
    setCurrentTry(1);
    scorePill.textContent = "Score: â€”";
    setStar(false);

    // If JSON contains score for current try, show last marked score for the highest marked try
    let lastMarkedTry = 0;
    for(const t of [1,2,3]) if(marked[t]) lastMarkedTry = t;
    if(lastMarkedTry && tryScore[lastMarkedTry]){
      setCurrentTry(lastMarkedTry);
      const s = tryScore[lastMarkedTry];
      scorePill.textContent = `Score: ${s.correct}/${s.total} (Need ${s.need})`;
      setStar(!!s.mastered);
    }

    // Disable inputs/speakers for marked tries; enable for unmarked unlocked tries
    for(const t of [1,2,3]){
      for(let i=0;i<TRIES[t].length;i++){
        const input = document.getElementById(`in-t${t}-${i}`);
        const spk = document.querySelector(`button.hear[data-try="${t}"][data-idx="${i}"]`);
        const disable = (!tryUnlocked[t]) || marked[t];
        if(input) input.disabled = disable;
        if(spk) spk.disabled = disable;
      }
    }

    alert("JSON loaded.");
  }catch(err){
    alert("Failed to load JSON. File may be corrupted.");
  }finally{
    importFile.value = "";
  }
});

/* ======================
   Reset
   ====================== */
function resetAll(){
  // reset stars / score
  setStar(false);
  scorePill.textContent = "Score: â€”";

  // state
  tryUnlocked = {1:true, 2:false, 3:false};
  marked = {1:false, 2:false, 3:false};
  tryScore = {1:null, 2:null, 3:null};

  // dates
  tryDate = {1: todayYMD(), 2:"", 3:""};
  renderDates();

  // answers / marks
  stateAnswers = {1:["",""], 2:["",""], 3:["",""]};
  stateMarks   = {1:["",""], 2:["",""], 3:["",""]};

  // rebuild
  rebuildAll();
  setCurrentTry(1);

  const first = document.getElementById("in-t1-0");
  if(first) first.focus();
}

resetBtn.addEventListener("click", resetAll);

/* ======================
   Init
   ====================== */
tryDate[1] = todayYMD();     // auto note date for 1st try (today)
renderDates();
setCurrentTry(1);
setStar(false);
</script>
</body>
</html>
