<!doctype html>
<html lang="en">
<head>
  <!-- PM (Spelling only) â€” Auto Mark | Designed by Lim Kim Sze Â© 2026 -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Cycle 2 PM â€” I Can Spell (Auto Mark)</title>

  <!-- Favicon (Kim Sze standard) -->
  <link rel="icon" href="./kimsze_sharp16.ico?v=20260111a" sizes="any">
  <link rel="shortcut icon" href="./kimsze_sharp16.ico?v=20260111a">

  <!-- âœ… Always-Clear on Load (Default Build Contract) -->
  <script>
  (function(){
    const ACTIVITY_ID = (window.ACTIVITY_ID || (location.origin + location.pathname));
    try{
      const del = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === ACTIVITY_ID) del.push(k);
        if(k.startsWith(ACTIVITY_ID+"::")) del.push(k);
        if(k.startsWith("sls_scope::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("UFCO-firstSubmit::"+ACTIVITY_ID)) del.push(k);
        if(k.startsWith("sls_unlike_payload::"+ACTIVITY_ID)) del.push(k);
      }
      del.forEach(k=>localStorage.removeItem(k));
      sessionStorage.removeItem("UFCO-firstSubmit::"+ACTIVITY_ID);
      sessionStorage.removeItem("sls_scope::"+ACTIVITY_ID);
      try{
        const bc = new BroadcastChannel("xapi-state");
        bc.postMessage({type:"clear", activityId: ACTIVITY_ID, ts: Date.now()});
        bc.close();
      }catch(e){}
    }catch(e){}
  })();
  </script>

  <!-- Counter.dev (Kim Sze standard) -->
  <script async src="https://cdn.counter.dev/script.js"
          data-id="REPLACE_WITH_YOUR_COUNTERDEV_ID"
          data-utcoffset="8"></script>

  <style>
    :root{
      --ink:#0b1220;
      --muted:#334155;
      --paper:#ffffff;

      --line:#0b0f17;
      --grey:#cfcfcf;

      --ok:#16a34a;
      --bad:#dc2626;

      --shadow: 0 18px 52px rgba(2, 6, 23, .12);
      --r:16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      background:#f3f4f6;
      color:var(--ink);
      overflow:auto;           /* âœ… mobile can scroll if needed */
      -webkit-tap-highlight-color: transparent;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:14px;
      box-sizing:border-box;
    }

    /* Card that mimics the booklet block */
    .card{
      width:min(980px, calc(100vw - 20px));
      background:var(--paper);
      border:5px solid var(--line);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* Header row like the booklet */
    .hdr{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px 10px;
      border-bottom:5px solid var(--line);
    }
    .hdr h1{
      margin:0;
      font-size:32px;
      font-weight:1000;
      text-decoration: underline;
      text-underline-offset: 6px;
    }
    .pencil{
      width:44px; height:44px;
      border-radius:10px;
      background:#e5e7eb;
      display:grid;
      place-items:center;
      font-weight:1000;
      color:#111827;
      user-select:none;
    }

    .sub{
      padding:0 16px 10px 16px;
      color:var(--muted);
      font-weight:800;
      font-size:14px;
      line-height:1.35;
    }

    /* Try headers row */
    .tryHead{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      border-top:5px solid var(--line);
      border-bottom:5px solid var(--line);
      background:var(--grey);
    }
    .tryHead div{
      padding:10px 12px;
      font-weight:1000;
      font-size:22px;
      border-left:5px solid var(--line);
    }
    .tryHead div:first-child{border-left:0;}

    /* Main 3-column area */
    .tries{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      min-height: 340px;
    }
    .tryCol{
      border-left:5px solid var(--line);
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .tryCol:first-child{border-left:0;}

    .blankArea{
      flex:1 1 auto;
      padding:18px 18px 10px;
      display:flex;
      flex-direction:column;
      gap:22px;
      min-height: 260px;
    }

    .line{
      display:grid;
      grid-template-columns: 40px 1fr 46px;
      gap:10px;
      align-items:end;
      min-width:0;
    }
    .idx{
      font-size:22px;
      font-weight:1000;
      text-align:right;
      padding-bottom:6px;
      user-select:none;
    }

    .ansWrap{min-width:0; position:relative;}
    .ans{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:22px;
      font-weight:900;
      letter-spacing:1px;
      text-transform:lowercase;
      padding:2px 6px 10px 6px;
      border-bottom:4px solid var(--line);
      box-sizing:border-box;
    }
    .ans:disabled{opacity:.55;}

    .hear{
      width:46px; height:46px;
      border-radius:14px;
      border:3px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-size:18px;
      display:grid;
      place-items:center;
      font-weight:1000;
      user-select:none;
      flex:0 0 auto;
    }
    .hear:active{transform:translateY(1px);}
    .hint{
      position:absolute;
      left:6px; bottom:-18px;
      font-size:12px;
      color:#94a3b8;
      font-weight:900;
      pointer-events:none;
    }

    /* Marking result under each line */
    .mk{
      margin-top:8px;
      min-height:28px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-weight:1000;
      font-size:18px;
    }
    .tick{color:var(--ok);}
    .cross{color:var(--bad);}

    .circWord{
      display:inline-flex;
      gap:2px;
      font-size:22px;
      letter-spacing:1px;
      text-transform:lowercase;
      align-items:center;
      flex-wrap:wrap;
    }
    .ch{
      display:inline-block;
      padding:0 3px;
      min-width:0.9em;
      text-align:center;
      line-height:1.1;
    }
    .wrong{
      border:3px solid #ef4444;
      border-radius:999px;
    }
    .miss{color:#ef4444;}

    /* Bottom star bar like the booklet */
    .starBar{
      background:var(--grey);
      border-top:5px solid var(--line);
      display:grid;
      grid-template-columns: 1fr 1fr;
      align-items:center;
      padding:14px 16px;
      gap:10px;
    }
    .starBox{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      font-weight:1000;
      font-size:26px;
      opacity:.65;
      border-radius:14px;
      padding:10px 12px;
      user-select:none;
    }
    .star{
      font-size:44px;
      line-height:1;
    }
    .starActive{
      opacity:1;
      background:#fff;
      border:4px solid var(--line);
    }

    /* Sticky action bar (so you ALWAYS see MARK button) */
    .actionBar{
      position:sticky;
      bottom:0;
      background:#ffffff;
      border-top:5px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      z-index:10;
      flex-wrap:wrap;
    }

    .leftCtl{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      box-shadow:0 10px 26px rgba(2,6,23,.12);
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px);}
    .btn.primary{background:#0ea5e9; color:#fff;}
    .btn.secondary{background:#64748b; color:#fff;}
    .btn.danger{background:#dc2626; color:#fff;}
    .btn:disabled{opacity:.45; cursor:not-allowed; transform:none;}

    .pill{
      border:3px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      font-weight:1000;
      background:#fff;
      white-space:nowrap;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:14px;
      background:#f1f5f9;
      border:1px solid #cbd5e1;
      font-weight:1000;
      white-space:nowrap;
    }
    .toggle input{width:18px; height:18px;}

    select{
      border:1px solid #cbd5e1;
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
      font-weight:900;
      max-width:260px;
    }

    .credit{
      padding:10px 14px;
      text-align:right;
      color:#64748b;
      font-weight:900;
      font-size:12px;
      border-top:1px solid #e5e7eb;
    }

    /* Mobile: keep three columns (like booklet), but reduce sizes a bit */
    @media (max-width: 520px){
      .hdr h1{font-size:26px;}
      .tryHead div{font-size:18px;}
      .idx{font-size:18px;}
      .ans{font-size:18px;}
      .starBox{font-size:18px;}
      .star{font-size:34px;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card" id="card">
    <div class="hdr">
      <h1>I Can Spell</h1>
      <div class="pencil" aria-hidden="true">âœŽ</div>
    </div>

    <div class="sub">
      Tap ðŸ”Š (or tap the blank) to hear: <b>word â†’ sentence â†’ word again</b>. Type your spelling.
      Press <b>MARK</b>. <b>Scoring focuses on the target phonogram only</b> (ff/ll/ss/zz at the end). Mastery is <b>about 80%</b>.
    </div>

    <div class="tryHead">
      <div>1st try</div>
      <div>2nd try</div>
      <div>3rd try</div>
    </div>

    <div class="tries" id="tries">
      <div class="tryCol" data-try="1">
        <div class="blankArea" id="area-1"></div>
      </div>
      <div class="tryCol" data-try="2">
        <div class="blankArea" id="area-2"></div>
      </div>
      <div class="tryCol" data-try="3">
        <div class="blankArea" id="area-3"></div>
      </div>
    </div>

    <div class="starBar">
      <div class="starBox starActive" id="workBox">
        <div class="star">â˜†</div>
        <div>Weâ€™re working on it!</div>
      </div>
      <div class="starBox" id="mastBox">
        <div class="star">â˜†</div>
        <div>Iâ€™ve mastered it! â˜º</div>
      </div>
    </div>

    <!-- âœ… Sticky: you will always see MARK -->
    <div class="actionBar">
      <div class="leftCtl">
        <button class="btn secondary" id="unlockBtn" type="button">Unlock Audio</button>

        <div class="toggle">
          <input id="soundOn" type="checkbox" checked>
          <label for="soundOn">Speech On</label>
        </div>

        <select id="voiceSel" aria-label="Voice selection"></select>

        <span class="pill" id="tryPill">Current: 1st try</span>
        <span class="pill" id="scorePill">Score: â€”</span>
      </div>

      <div class="leftCtl">
        <button class="btn primary" id="markBtn" type="button">MARK</button>
        <button class="btn danger" id="resetBtn" type="button">New Pupil â€” Clear</button>
      </div>
    </div>

    <div class="credit">Designed by Lim Kim Sze Â© 2026</div>
  </div>
</div>

<script>
/* ======================
   Words (from your Teacher's Scoring Booklet image)
   Mapping:
   - 1st try (PM):     Fill, Dress
   - 2nd try (PM DI):  Stuff, Miss
   - 3rd try (PM DI):  Less, Jazz
   ====================== */
const TRIES = {
  1: [
    { word:"fill",  sentence:"Fill. Fill up your water bottle before PE lesson. Fill." },
    { word:"dress", sentence:"Dress. She bought a new dress to wear for her birthday party. Dress." }
  ],
  2: [
    { word:"stuff", sentence:"Stuff. Eat slowly and do not stuff the food into your mouth. Stuff." },
    { word:"miss",  sentence:"Miss. I will miss my friend when he goes to another school. Miss." }
  ],
  3: [
    { word:"less",  sentence:"Less. He ate less rice today as he was not hungry. Less." },
    { word:"jazz",  sentence:"Jazz. He listens to jazz music to relax. Jazz." }
  ]
};

const TARGETS = ["ff","ll","ss","zz"];

const soundOn  = document.getElementById("soundOn");
const voiceSel = document.getElementById("voiceSel");
const unlockBtn= document.getElementById("unlockBtn");
const markBtn  = document.getElementById("markBtn");
const resetBtn = document.getElementById("resetBtn");

const workBox  = document.getElementById("workBox");
const mastBox  = document.getElementById("mastBox");

const tryPill   = document.getElementById("tryPill");
const scorePill = document.getElementById("scorePill");

let unlocked = false;
let currentTry = 1;
let marked = {1:false, 2:false, 3:false};

function ensureUnlocked(){
  if(unlocked) return;
  unlocked = true;
  unlockBtn.textContent = "Audio Unlocked";
  unlockBtn.disabled = true;
  if("speechSynthesis" in window){
    setTimeout(loadVoices, 0);
  }
}

function cleanAnswer(s){
  return (s||"").toLowerCase().replace(/[^a-z]/g,"");
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  })[m]);
}

function targetForWord(expected){
  const w = cleanAnswer(expected);
  for(const t of TARGETS){
    if(w.endsWith(t)) return t;
  }
  return w.slice(-2);
}

function masteryNeed(n){
  // about 80% (matches examples)
  return Math.max(1, Math.round(0.8*n));
}

/* ======================
   Build booklet-like lines
   ====================== */
function lineHtml(tryNo, idx){
  const id = `t${tryNo}-${idx}`;
  const disabled = (tryNo !== 1); // only 1st try open at start
  return `
    <div>
      <div class="line" id="row-${id}">
        <div class="idx">${idx+1})</div>
        <div class="ansWrap">
          <input class="ans" id="in-${id}" ${disabled ? "disabled" : ""} autocomplete="off" spellcheck="false" inputmode="text">
          <div class="hint">tap ðŸ”Š or tap blank</div>
        </div>
        <button class="hear" type="button" data-try="${tryNo}" data-idx="${idx}">ðŸ”Š</button>
      </div>
      <div class="mk" id="mk-${id}"></div>
    </div>
  `;
}

for(const t of [1,2,3]){
  document.getElementById(`area-${t}`).innerHTML =
    TRIES[t].map((_,i)=>lineHtml(t,i)).join("");
}

/* force lowercase while typing */
document.addEventListener("input", (e)=>{
  const el = e.target;
  if(el && el.classList && el.classList.contains("ans")){
    const pos = el.selectionStart;
    el.value = el.value.toLowerCase();
    try{ el.setSelectionRange(pos,pos); }catch(_){}
  }
});

/* ======================
   TTS
   ====================== */
function speak(text){
  if(!soundOn.checked) return;
  if(!("speechSynthesis" in window)) return;
  if(!unlocked) return;

  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);

  const vName = voiceSel.value;
  const voices = window.speechSynthesis.getVoices() || [];
  const v = voices.find(x=>x.name===vName);
  if(v) u.voice = v;

  u.rate = 0.95;
  u.pitch = 1.0;
  u.volume = 1.0;

  window.speechSynthesis.speak(u);
}

function loadVoices(){
  if(!("speechSynthesis" in window)) return;
  const voices = window.speechSynthesis.getVoices() || [];
  if(!voices.length) return;

  const prev = voiceSel.value;
  voiceSel.innerHTML = "";

  const sorted = [...voices].sort((a,b)=>{
    const ae = (a.lang||"").toLowerCase().startsWith("en") ? 0 : 1;
    const be = (b.lang||"").toLowerCase().startsWith("en") ? 0 : 1;
    if(ae!==be) return ae-be;
    return (a.name||"").localeCompare(b.name||"");
  });

  for(const v of sorted){
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang||"?"})`;
    voiceSel.appendChild(opt);
  }

  if(prev && [...voiceSel.options].some(o=>o.value===prev)) voiceSel.value = prev;
  else voiceSel.selectedIndex = 0;
}
if("speechSynthesis" in window){
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}

unlockBtn.addEventListener("click", ()=>{
  ensureUnlocked();
  speak("Audio unlocked.");
});

/* ======================
   Speak when tap ðŸ”Š OR tap blank
   ====================== */
function speakPrompt(tryNo, idx){
  const item = TRIES[tryNo][idx];
  const w = item.word;
  const s = item.sentence;
  ensureUnlocked();
  speak(`Spell this word. ${w}. ${s} The word again. ${w}.`);
}

document.addEventListener("click", (e)=>{
  const spk = e.target.closest(".hear");
  if(spk){
    const t = +spk.dataset.try;
    const i = +spk.dataset.idx;
    const input = document.getElementById(`in-t${t}-${i}`);
    if(input && !input.disabled) input.focus();
    speakPrompt(t,i);
    return;
  }
});

document.addEventListener("focusin", (e)=>{
  const el = e.target;
  if(!el || !el.classList || !el.classList.contains("ans")) return;
  if(el.disabled) return;

  const m = (el.id||"").match(/^in-t(\d+)-(\d+)$/);
  if(!m) return;

  const t = +m[1];
  const i = +m[2];

  // only speak if empty (so it won't keep talking while editing)
  if((el.value||"").trim()) return;

  speakPrompt(t,i);
});

/* ======================
   Marking: circle wrong letters (compared to target word),
   but correctness = target phonogram at end (rule only).
   ====================== */
function circledDiffHtml(answerRaw, expectedRaw){
  const ans = cleanAnswer(answerRaw);
  const exp = cleanAnswer(expectedRaw);

  if(!ans) return `<span class="miss">[ no response ]</span>`;

  const max = Math.max(ans.length, exp.length);
  let out = `<span class="circWord">`;
  for(let i=0;i<max;i++){
    const a = ans[i];
    const e = exp[i];
    if(a === undefined){
      out += `<span class="ch wrong">âˆ…</span>`;
    }else if(e === undefined){
      out += `<span class="ch wrong">${escapeHtml(a)}</span>`;
    }else{
      const wrong = (a !== e);
      out += `<span class="ch ${wrong ? "wrong" : ""}">${escapeHtml(a)}</span>`;
    }
  }
  out += `</span>`;
  return out;
}

function setStar(mastered){
  if(mastered){
    workBox.classList.remove("starActive");
    mastBox.classList.add("starActive");
  }else{
    mastBox.classList.remove("starActive");
    workBox.classList.add("starActive");
  }
}

function setCurrentTry(t){
  currentTry = t;
  const name = (t===1 ? "1st try" : t===2 ? "2nd try" : "3rd try");
  tryPill.textContent = `Current: ${name}`;
}

function enableTry(t){
  for(let i=0;i<2;i++){
    const input = document.getElementById(`in-t${t}-${i}`);
    if(input){ input.disabled = false; }
  }
  setCurrentTry(t);
}

function markCurrentTry(){
  const t = currentTry;
  if(marked[t]) return;

  const total = TRIES[t].length; // 2
  const need = masteryNeed(total);
  let correct = 0;

  for(let i=0;i<total;i++){
    const expected = TRIES[t][i].word;
    const target = targetForWord(expected);

    const input = document.getElementById(`in-t${t}-${i}`);
    const mk = document.getElementById(`mk-t${t}-${i}`);

    const raw = input ? input.value : "";
    const ans = cleanAnswer(raw);

    const ok = ans.endsWith(target) && ans.length >= target.length; // rule only
    if(ok) correct++;

    if(mk){
      mk.innerHTML = `
        ${circledDiffHtml(raw, expected)}
        <span class="${ok ? "tick":"cross"}">${ok ? "âœ“" : "âœ—"}</span>
        <span style="font-size:13px; color:#475569;">(target: -${target} at the end)</span>
      `;
    }

    if(input) input.disabled = true;
  }

  marked[t] = true;
  const mastered = (correct >= need);
  scorePill.textContent = `Score: ${correct}/${total} (Need ${need})`;

  setStar(mastered);

  if(unlocked && soundOn.checked){
    speak(mastered
      ? `Well done. You have mastered it. You got ${correct} out of ${total}.`
      : `Keep going. You got ${correct} out of ${total}.`);
  }

  // If not mastered, open next try automatically
  if(!mastered){
    if(t === 1){ enableTry(2); return; }
    if(t === 2){ enableTry(3); return; }
  }

  // If mastered, keep current try
}

markBtn.addEventListener("click", ()=>{
  ensureUnlocked(); // so MARK can also unlock on mobile
  markCurrentTry();
});

function resetAll(){
  setStar(false);
  scorePill.textContent = "Score: â€”";
  marked = {1:false, 2:false, 3:false};

  for(const t of [1,2,3]){
    for(let i=0;i<2;i++){
      const input = document.getElementById(`in-t${t}-${i}`);
      const mk = document.getElementById(`mk-t${t}-${i}`);
      if(input){
        input.value = "";
        input.disabled = (t !== 1);
      }
      if(mk) mk.innerHTML = "";
    }
  }
  setCurrentTry(1);
  const first = document.getElementById("in-t1-0");
  if(first) first.focus();
}

resetBtn.addEventListener("click", resetAll);

// init
setCurrentTry(1);
setStar(false);
</script>
</body>
</html>
